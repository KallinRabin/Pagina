<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voz Ciudadana - Uruguay</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Iconos FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Cropper.js para recorte profesional de fotos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- WebAuthn y OCR para Identidad -->
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
</head>

<body>

    <div class="admin-indicator">MODO ADMINISTRADOR ACTIVO</div>

    <header>
        <div class="header-container">
            <div class="logo" onclick="location.reload()">
                <i class="fas fa-bullhorn"></i> Voz<b>Ciudadana</b>
            </div>

            <nav class="nav-links">
                <div id="auth-zone" class="auth-buttons">
                    <button class="btn-login" onclick="abrirAuth(); switchAuth('log')">Iniciar SesiÃ³n</button>
                    <button class="btn-register" onclick="abrirAuth(); switchAuth('reg')">Registrarse</button>
                </div>
            </nav>
        </div>
    </header>

    <section class="hero">
        <h1>Tu voz transforma tu comunidad</h1>
        <p>Reporta quejas, propone ideas o comparte noticias de tu departamento.</p>
    </section>

    <div class="filter-zone">
        <div class="selector-group">
            <i class="fas fa-map-marker-alt"></i>
            <select id="main-dept-filter" onchange="cambiarDepartamento()">
                <option value="todos">Todo el Uruguay</option>
            </select>
        </div>

        <div class="category-nav">
            <button class="cat-btn active" onclick="filtrarCategoria('todas')" data-cat="todas">Todo</button>
            <button class="cat-btn" onclick="filtrarCategoria('Queja')" data-cat="Queja">Quejas</button>
            <button class="cat-btn" onclick="filtrarCategoria('Idea')" data-cat="Idea">Ideas</button>
            <button class="cat-btn" onclick="filtrarCategoria('Noticia')" data-cat="Noticia">Noticias</button>
        </div>
    </div>

    <div class="container">

        <div class="action-grid">
            <div class="card card-queja" onclick="abrirModal('Queja')">
                <div class="card-icon">ðŸ“¢</div>
                <h3>Denunciar</h3>
                <p>Â¿Algo no funciona? RepÃ³rtalo aquÃ­.</p>
            </div>
            <div class="card card-idea" onclick="abrirModal('Idea')">
                <div class="card-icon">ðŸ’¡</div>
                <h3>Proponer</h3>
                <p>Comparte una idea para mejorar tu zona.</p>
            </div>
            <div class="card card-noticia" onclick="abrirModal('Noticia')">
                <div class="card-icon">ðŸ“°</div>
                <h3>Informar</h3>
                <p>Publica una noticia o evento local.</p>
            </div>
        </div>

        <div id="admin-dashboard" class="status-summary" style="display: none;">
        </div>

        <div id="feed-container">
            <div style="text-align:center; padding:20px;">Cargando publicaciones...</div>
        </div>
    </div>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Nueva PublicaciÃ³n</h2>
            <form id="postForm">
                <input type="hidden" id="post-type">

                <div class="input-group">
                    <label>TÃ­tulo</label>
                    <input type="text" id="post-titulo" placeholder="Â¿QuÃ© estÃ¡ pasando?" required>
                </div>

                <div class="input-group">
                    <label>Contenido / Detalles</label>
                    <textarea id="post-contenido" rows="4" placeholder="Describe la situaciÃ³n..." required></textarea>
                </div>

                <div class="input-group">
                    <label>Departamento</label>
                    <select id="post-dept" required></select>
                </div>

                <div class="input-group">
                    <label><i class="fas fa-paperclip"></i> Adjuntar Multimedia (ImÃ¡genes, Video o PDF)</label>
                    <input type="file" id="post-files" multiple accept="image/*,video/*,application/pdf"
                        capture="environment">
                    <small style="color: #666;">MÃ¡ximo 5MB por sesiÃ³n de navegaciÃ³n.</small>
                </div>

                <div class="input-group" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="post-anonimo" style="width:auto;">
                    <label for="post-anonimo" style="margin:0;">Publicar de forma anÃ³nima</label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn-submit">Publicar Ahora</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="authModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="text-align:right;">
                <span style="cursor:pointer; font-size:1.5rem;" onclick="cerrarAuth()">&times;</span>
            </div>

            <div id="auth-step-1">
                <h2 id="auth-title-trigger" style="cursor:default; user-select:none; margin-bottom:10px;">Identidad
                    Ciudadana</h2>
                <p style="margin-bottom:20px; color:#666;">Ingresa tu CÃ©dula de Identidad (Uruguay)</p>

                <div class="input-group">
                    <input type="text" id="auth-cedula" placeholder="1.234.567-8" required
                        style="text-align:center; font-size: 1.5rem; border-radius:12px; border:2px solid #ddd;"
                        maxlength="11">
                </div>

                <div id="master-pin-group"
                    style="display:none; margin-top:15px; padding:10px; background:#f0faff; border-radius:8px; border:1px dashed var(--secondary);">
                    <p style="color:var(--secondary); font-size:0.8rem; font-weight:bold; margin-bottom:5px;">ðŸ”‘ MODO
                        MAESTRO</p>
                    <input type="password" id="auth-master-pin" placeholder="PIN Maestro"
                        style="text-align:center; border-color:var(--secondary);">
                </div>

                <div id="auth-name-group" style="display:none; margin-top:20px;">
                    <p style="margin-bottom:10px;">Â¡Bienvenido! Completa tu registro:</p>
                    <div class="input-group">
                        <input type="text" id="auth-nombre" placeholder="Nombre y Apellido" style="text-align:center;">
                    </div>
                </div>

                <button id="btn-auth-next" class="btn-submit" onclick="handleAuthStep1()"
                    style="width: 100%; margin-top:20px; height:50px; font-size:1.1rem;">Continuar</button>
            </div>

            <div id="auth-step-2" style="display:none;">
                <h2 style="margin-bottom:10px;">VerificaciÃ³n Final</h2>
                <p id="auth-step-2-msg" style="margin-bottom:25px; color:#666;">CÃ©dula validada correctamente.</p>

                <div style="font-size: 4rem; margin: 20px 0; color: var(--primary);">
                    <i id="auth-icon" class="fas fa-fingerprint"></i>
                </div>

                <button id="btn-biometric" class="btn-submit"
                    style="width: 100%; height:50px; font-size:1.1rem; margin-bottom:15px;">
                    Iniciar BiometrÃ­a
                </button>

                <button type="button" onclick="resetAuth()" class="btn-cancel"
                    style="width:100%; background:none; color:#777; border:none; cursor:pointer;">
                    <i class="fas fa-arrow-left"></i> Volver a empezar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil Profesional -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div style="text-align:right;">
                <span style="cursor:pointer; font-size:1.5rem;" onclick="cerrarProfile()">&times;</span>
            </div>
            <h2 style="text-align:center; margin-bottom:20px;">Gestionar Perfil</h2>

            <div style="text-align:center; margin-bottom:25px; position:relative;">
                <img id="profile-preview" src="https://ui-avatars.com/api/?name=User&background=random"
                    style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid var(--primary); display:block; margin:0 auto 10px auto; box-shadow:0 6px 15px rgba(0,0,0,0.15);">

                <div style="display:flex; justify-content:center; gap:10px;">
                    <label for="profile-file"
                        style="cursor:pointer; color:var(--primary); font-weight:bold; font-size:0.8rem; background:#f0f7ff; padding:8px 15px; border-radius:20px; border:1px solid #cce3ff;">
                        <i class="fas fa-camera"></i> Subir/Cambiar
                    </label>
                    <button id="btn-delete-pfp" onclick="eliminarFotoPerfil()"
                        style="cursor:pointer; color:#dc3545; font-weight:bold; font-size:0.8rem; background:#fff5f5; padding:8px 15px; border-radius:20px; border:1px solid #ffd8d8;">
                        <i class="fas fa-trash"></i> Quitar
                    </button>
                </div>
                <input type="file" id="profile-file" accept="image/*" style="display:none;" onchange="initCropper(this)"
                    capture="environment">
            </div>

            <div class="input-group">
                <label>Nombre PÃºblico</label>
                <input type="text" id="profile-name" placeholder="Tu nombre artÃ­stico o real">
            </div>

            <div class="input-group">
                <label>Departamento de Residencia</label>
                <select id="profile-dept" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <option value="">Selecciona tu departamento</option>
                    <option value="Artigas">Artigas</option>
                    <option value="Canelones">Canelones</option>
                    <option value="Cerro Largo">Cerro Largo</option>
                    <option value="Colonia">Colonia</option>
                    <option value="Durazno">Durazno</option>
                    <option value="Flores">Flores</option>
                    <option value="Florida">Florida</option>
                    <option value="Lavalleja">Lavalleja</option>
                    <option value="Maldonado">Maldonado</option>
                    <option value="Montevideo">Montevideo</option>
                    <option value="PaysandÃº">PaysandÃº</option>
                    <option value="RÃ­o Negro">RÃ­o Negro</option>
                    <option value="Rivera">Rivera</option>
                    <option value="Rocha">Rocha</option>
                    <option value="Salto">Salto</option>
                    <option value="San JosÃ©">San JosÃ©</option>
                    <option value="Soriano">Soriano</option>
                    <option value="TacuarembÃ³">TacuarembÃ³</option>
                    <option value="Treinta y Tres">Treinta y Tres</option>
                </select>
            </div>

            <div class="input-group">
                <label>Email de Usuario</label>
                <input type="text" id="profile-email" disabled style="background:#f9f9f9; color:#888;">
            </div>

            <!-- SecciÃ³n de Nivel y XP -->
            <div id="profile-level-section"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; padding:20px; margin:15px 0; text-align:center; color:white;">
                <div style="font-size:2.5rem;" id="profile-insignia">ðŸŒ±</div>
                <div style="font-size:1.2rem; font-weight:bold; margin:5px 0;" id="profile-nivel-nombre">Ciudadano
                    Novato</div>
                <div style="font-size:0.9rem; opacity:0.9;">Nivel <span id="profile-nivel-num">1</span></div>
                <div style="margin-top:15px;">
                    <div style="background:rgba(255,255,255,0.3); border-radius:10px; height:12px; overflow:hidden;">
                        <div id="profile-xp-bar"
                            style="background:#fff; height:100%; width:0%; transition:width 0.5s ease;"></div>
                    </div>
                    <div style="font-size:0.8rem; margin-top:5px;">
                        <span id="profile-xp-actual">0</span> / <span id="profile-xp-siguiente">40</span> XP
                    </div>
                </div>
            </div>

            <!-- SECCIÃ“N: VERIFICACIÃ“N DE IDENTIDAD -->
            <div id="verification-section"
                style="margin: 20px 0; padding: 15px; border: 2px dashed #e0e0e0; border-radius: 12px; background: #fafafa;">
                <label style="font-weight: bold; color: var(--secondary); display: block; margin-bottom: 10px;">
                    <i class="fas fa-id-card"></i> VerificaciÃ³n de Identidad (OCR)
                </label>

                <div id="verify-status-box" style="text-align: center;">
                    <div id="verify-loading" style="display:none; padding: 10px;">
                        <i class="fas fa-spinner fa-spin" style="color: var(--primary); font-size: 1.5rem;"></i>
                        <p style="margin-top:10px; font-size: 0.9rem;">Leyendo tu CÃ©dula...<br><small>(Esto puede tardar
                                unos segundos)</small></p>
                    </div>

                    <div id="verify-prompt">
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Para publicar o votar,
                            necesitamos confirmar que eres un ciudadano real.</p>
                        <button class="btn-submit" onclick="document.getElementById('ci-photo-input').click()"
                            style="background: var(--secondary); font-size: 0.9rem; padding: 8px 20px; width: auto;">
                            <i class="fas fa-camera"></i> Validar mi CÃ©dula
                        </button>
                    </div>

                    <div id="verify-success" style="display:none; color: #28a745;">
                        <i class="fas fa-check-circle" style="font-size: 3rem;"></i>
                        <h4 style="margin: 10px 0 5px;">Â¡Ciudadano Verificado!</h4>
                        <p style="font-size: 0.8rem; opacity: 0.8;">Tu identidad ha sido confirmada automÃ¡ticamente.</p>
                    </div>
                </div>
                <input type="file" id="ci-photo-input" accept="image/*" style="display:none;"
                    onchange="procesarVerificacionCI(this)" capture="environment">
            </div>

            <button class="btn-submit" onclick="guardarPerfil()"
                style="width:100%; padding:12px; font-size:1rem;">Guardar Perfil</button>
        </div>
    </div>

    <!-- Modal para Recortar Imagen -->
    <div id="cropperModal" class="modal" style="z-index: 6000;">
        <div class="modal-content" style="max-width: 500px;">
            <h3>Ajustar Foto de Perfil</h3>
            <div style="max-height: 400px; overflow: hidden; margin-bottom: 20px;">
                <img id="cropper-image" style="max-width: 100%;">
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="cerrarCropper()">Cancelar</button>
                <button class="btn-submit" onclick="recortarYGuardar()">Recortar y Aplicar</button>
            </div>
        </div>
    </div>


    <!-- Modal de ConfirmaciÃ³n -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <i class="fas fa-exclamation-circle" style="font-size:3rem; color: #dc3545; margin-bottom:15px;"></i>
            <h3 id="confirm-title" style="margin-top:0;">Â¿EstÃ¡s seguro?</h3>
            <p id="confirm-msg">Esta acciÃ³n no se puede deshacer.</p>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn-cancel" onclick="cerrarConfirm()" style="margin:0">Cancelar</button>
                <button id="confirm-btn-yes" class="btn-submit"
                    style="background: #dc3545; border:none;">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Contenedor para Hover Card (Tooltip de usuario) -->
    <div id="user-hover-card" class="user-hover-card"></div>

    <script src="js/app.js"></script>
</body>

</html>